# 文本检索大作业实验报告

王思远 2022.05.06

题目详见`prob.zip`

## 文件说明

`data_gen.ipynb`: 实现了数据预处理和文章聚类与评价，输入为 `data/all_news.csv`（原数据） 和 `data/stopwords.txt`（停用词），将其中代码块全部运行后可以得到以下文件：

> `data/processed_news.csv`: 对原数据去除重复的文本得到
> 
> `data/vocab.txt`: 构建的词典
> 
> `data/tfidf.npy`: 计算出的 TFIDF 矩阵
> 
> `data/synonym_words.npy`: 词典中每个词的相似词（保存单词编号）
> 
> `data/synonym_score.npy`: 词典中每个词的相似词与其相似度
> 
> `data/synonym.txt`: 词典中每个词的相似词
> 
> 以上预处理得到的文件除 `tfidf.npy` 外都存放在 `data` 文件夹中，`tfidf.npy` 需要运行 `data_gen.ipynb` 得到，因为其文件太大就不上传了。

`GUI.py` 定义了客户端的用户图形界面，运行即可启动客户端，可以向服务器发送请求，以及解析服务器返回的结果。

`local_server.py` 在本机上模拟服务器端，接收客户端的文本检索请求，根据检索词检索文本、重排序并返回给客户端。可以并发处理客户端发来的请求。

在使用时，需要先在服务器上运行 `data_gen.ipynb` 中全部代码块获得预处理文件，再在服务器上运行`local_server.py` 启动服务器，最后在客户端上运行`GUI.py` 进行检索即可。

## 基础要求实现情况

##### 数据处理

在`data_gen.ipynb`中对文章去重，进行了词形还原、去标点、分词、去除停用词、去除低频词（可选），并构建了词典，进行保存。

##### 检索排序

根据输入的检索词检索文章并返回，使用了C/S架构。在客户端可以输入1至3个检索词，可以选择是否进行模糊匹配、是否要求文本必须包含全部检索词。

##### 排序优化

在`data_gen.ipynb`中计算了文档-词的TFIDF矩阵并保存，降维到1000维作为文章向量，以之度量文章之间的余弦相似度，根据相似度优化了检索结果。

使用HITS算法对检索出的文章进行了重排序，详细的排序算法见后文“检索算法和排序算法”。

在`data_gen.ipynb`中为HITS算法选择了合适的文章相似度阈值为0.2，相似度高于0.2的两篇文章认为是相似的文章。

##### 文章聚类与评价

使用KMeans算法对文章向量进行聚类，并与原数据集中的正确分类进行比较，计算Purity和F值。

使用原始TFIDF作为文章向量聚类：`Purity = 0.8175834508697697 F = 0.8304922669535855`

使用降维至1000维的文章向量聚类：`Purity = 0.8251057827926658 F = 0.8289094063523672`

可以看到，使用降维至1000维的文章向量效果尚可，保留了大部分信息。

##### 相似词

在`data_gen.ipynb`中将TFIDF矩阵转置得到词向量，使用其余弦相似度挖掘相似词并保存。对于每个词 word，取与word相似度前六的词，除去它本身，作为其相似词，并保存。

##### 模糊匹配

如果用户勾选“模糊匹配”，则利用相似词拓展检索结果集合，并排序。排序算法详见后文“检索算法和排序算法”。

## 加分项实现情况

##### 优化TKinter的功能

在检索主界面上增加“文本必须包含全部检索词”和“模糊匹配”勾选框。

如果勾选“文本必须包含全部检索词”，则服务器只返回包含全部检索词的文本；否则会返回至少包含一个检索词（或检索词的相似词）的文本。

如果勾选“模糊匹配”，则服务器会在检索和排序时进行模糊匹配。

如果同时勾选，服务器会在检索和排序时进行模糊匹配，但返回时只会返回包含全部检索词的文本。

同时，每次检索结束，在检索主界面会显示此次检索到的文本数量。

## 检索算法和排序算法

##### 检索算法

首先，如果用户选择了模糊匹配，则用相似词扩展检索词集合。

然后由$\text{TF-TDF}[i,j]>0\Leftrightarrow 文章i中包含单词j$，检索出包含检索词至少一个的文章，构成文章集合。

##### 排序算法

令 $S$ 为初始的检索词的集合，$S$ 中每个词的评分都为1.0。

$\forall x \in S, word\_score(x)=1.0$

如果使用模糊排序算法，则令$S'$ 为与 $S$ 中的词相似的词的集合。

 $S'=\cup\ similar\_news(x), \forall x\in S$

$S'$ 中每个词的评分为该词与各检索词相似度的最大值。

 $\forall x' \in S', word\_score(x')=\max_{ x \in S}similarity(x,x')$

令检索到的文章集合为 $T$。

$\forall t \in T,score1(t)=\sum_{x \in S\cup S'}word\_score(x)·\text{TF-IDF}[t,x]$

文章的 $score2$ 由HITS算法算出：

> HITS算法：
> 
> 1. 计算文本间的相似度
> 2. 用检索词命中一组文本
> 3. 将与这些文本有关联关系的文本加入文本集合（相似度高于0.2视为有关联关系）
> 4. 文本间的相似度构成一个对称矩阵
> 5. 迭代求该矩阵的主特征向量
> 6. $score2$ 评分即为该矩阵每行与该向量的余弦相似度

对 $score1$ 和 $score2$ 评分分别进行标准化，计算 $score=\alpha score1+(1-\alpha)score2$，即为文章的最终评分。按最终评分从高到低重排序即可。